<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡±/ìˆ í¬ì§€ì…˜ ë¹„ìœ¨ - Mablewide Clone</title>
    
    <!-- Prevent FOUC (Flash of Unstyled Content) for dark mode -->
    <script>
        (function() {
            // Check for saved theme preference or default to system preference
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else if (savedTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
    </script>
    
    <!-- ë¡œê·¸ì¸ ê°€ë“œ -->
    <script>
        // í† í° ê²€ì¦ ë¡œì§ì„ auth.jsì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ ë‹¨ìˆœí™”
        const token = localStorage.getItem('token');
        if (!token) {
            // í† í° ì—†ìœ¼ë©´ ì›°ì»´ í˜ì´ì§€ë¡œ
            window.location.href = '/welcome.html';
        }
    </script>
    
    <link rel="stylesheet" href="assets/css/base.css">
    <link rel="stylesheet" href="assets/css/layout.css">
    <link rel="stylesheet" href="assets/css/nav.css">
    <link rel="stylesheet" href="assets/css/header.css">
    <link rel="stylesheet" href="assets/css/footer.css">
    <link rel="stylesheet" href="assets/css/longshort.css">
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Apply saved theme on page load (backup for DOMContentLoaded)
        document.addEventListener('DOMContentLoaded', () => {
            const currentTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (currentTheme === 'dark' || (!currentTheme && systemPrefersDark)) {
                document.body.setAttribute('data-theme', 'dark');
            } else if (currentTheme === 'light') {
                document.body.setAttribute('data-theme', 'light');
            }
        });
    </script>
</head>
<body>
    <div id="wrapper">
        <div id="nav-placeholder"></div>
        <div class="content-wrapper">
            <div id="header-placeholder"></div>
            <main id="longshort-content">
                <div class="longshort-container">
                    <div class="longshort-layout">
                        <div class="longshort-controls">
                            <div class="longshort-header">
                                <div class="controls">
                                    <select id="symbol-select" class="symbol-selector">
                                        <option value="BTCUSDT">BTC/USDT</option>
                                        <option value="ETHUSDT">ETH/USDT</option>
                                        <option value="SOLUSDT">SOL/USDT</option>
                                        <option value="ADAUSDT">ADA/USDT</option>
                                        <option value="DOGEUSDT">DOGE/USDT</option>
                                        <option value="XRPUSDT">XRP/USDT</option>
                                        <option value="AVAXUSDT">AVAX/USDT</option>
                                        <option value="DOTUSDT">DOT/USDT</option>
                                    </select>
                                    <button id="refresh-btn" class="refresh-button">ğŸ”„ ì‹¤ì‹œê°„ ë°ì´í„°</button>
                                </div>
                            </div>

                            <div class="legend">
                                <div class="legend-item">
                                    <span class="legend-color long"></span>
                                    <span>ë¡± í¬ì§€ì…˜ (Long)</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-color short"></span>
                                    <span>ìˆ í¬ì§€ì…˜ (Short)</span>
                                </div>
                            </div>

                        </div>
                        
                        <div class="chart-section">
                            <div class="chart-wrapper">
                                <div id="loading" class="loading-indicator">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                                <div id="error" class="error-message" style="display: none;"></div>
                                <canvas id="longShortChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            <div id="footer-placeholder"></div>
        </div>
    </div>

    <script type="module" src="assets/js/main.js"></script>
    <script type="module" src="assets/js/auth.js"></script>
    <script>
        let chart = null;
        
        // í˜„ì¬ í™˜ê²½ ê°ì§€
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API_BASE_URL = isLocalhost ? 'http://localhost:3000' : '';
        
        // ìƒ˜í”Œ ë°ì´í„° ìƒì„± í•¨ìˆ˜
        function generateSampleData(symbol) {
            const data = [];
            const now = Date.now();
            
            for (let i = 9; i >= 0; i--) {
                const timestamp = now - (i * 5 * 60 * 1000); // 5ë¶„ ê°„ê²©
                // ë¡±/ìˆ ë¹„ìœ¨ì„ í˜„ì‹¤ì ìœ¼ë¡œ ì‹œë®¬ë ˆì´ì…˜ (í•©ê³„ê°€ 1ì´ ë˜ë„ë¡)
                const longRatio = 0.45 + Math.random() * 0.2; // 45-65% ë²”ìœ„
                const shortRatio = 1 - longRatio;
                
                data.push({
                    symbol: symbol,
                    longShortRatio: (longRatio / shortRatio).toFixed(4),
                    longAccount: longRatio.toFixed(4),
                    shortAccount: shortRatio.toFixed(4),
                    timestamp: timestamp
                });
            }
            
            return data;
        }
        
        // ë°±ì—”ë“œ APIì—ì„œ ì‹¤ì‹œê°„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function fetchRealTimeData(symbol) {
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error');
            
            try {
                loadingElement.style.display = 'block';
                errorElement.style.display = 'none';
                
                const response = await fetch(`${API_BASE_URL}/api/bybit/longshort?symbol=${symbol}&limit=10`);
                
                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
                }
                
                const data = await response.json();
                loadingElement.style.display = 'none';
                
                console.log(`ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë“œ ì„±ê³µ: ${symbol}`);
                return data;
                
            } catch (error) {
                loadingElement.style.display = 'none';
                console.error('ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                
                // ë°±ì—”ë“œ ì„œë²„ ì—°ê²° ì‹¤íŒ¨ì‹œ ìƒ˜í”Œ ë°ì´í„°ë¡œ í´ë°±
                errorElement.style.display = 'block';
                errorElement.innerHTML = `
                    <strong>ë°±ì—”ë“œ ì„œë²„ ì—°ê²° ì‹¤íŒ¨</strong><br>
                    ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒ˜í”Œ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.<br>
                    <small>ë°±ì—”ë“œ ì„œë²„ë¥¼ ì‹œì‘í•˜ë ¤ë©´: npm run dev (backend í´ë”ì—ì„œ)</small>
                `;
                
                return generateSampleData(symbol);
            }
        }
        
        // ìƒ˜í”Œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function fetchSampleData(symbol) {
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error');
            
            try {
                loadingElement.style.display = 'block';
                errorElement.style.display = 'none';
                
                // ë¨¼ì € ë°±ì—”ë“œ ìƒ˜í”Œ API ì‹œë„
                try {
                    const response = await fetch(`${API_BASE_URL}/api/sample/longshort?symbol=${symbol}`);
                    if (response.ok) {
                        const data = await response.json();
                        loadingElement.style.display = 'none';
                        console.log(`ë°±ì—”ë“œ ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ ì„±ê³µ: ${symbol}`);
                        return data;
                    }
                } catch (e) {
                    console.log('ë°±ì—”ë“œ ìƒ˜í”Œ API ì‹¤íŒ¨, ë¡œì»¬ ìƒì„± ì‚¬ìš©');
                }
                
                // ë°±ì—”ë“œ ì‹¤íŒ¨ì‹œ ë¡œì»¬ ìƒì„±
                const data = generateSampleData(symbol);
                loadingElement.style.display = 'none';
                console.log(`ë¡œì»¬ ìƒ˜í”Œ ë°ì´í„° ìƒì„±: ${symbol}`);
                return data;
                
            } catch (error) {
                loadingElement.style.display = 'none';
                console.error('ìƒ˜í”Œ ë°ì´í„° ìƒì„± ì‹¤íŒ¨:', error);
                return generateSampleData(symbol);
            }
        }
        
        // íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ MM/DD HH:mm í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${month}/${day} ${hours}:${minutes}`;
        }
        
        // Chart.jsë¡œ ë§‰ëŒ€ê·¸ë˜í”„ ìƒì„±
        function createChart(data, symbol) {
            const ctx = document.getElementById('longShortChart').getContext('2d');
            
            // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì œê±°
            if (chart) {
                chart.destroy();
            }
            
            // ë°ì´í„°ë¥¼ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ (ì˜¤ë˜ëœ ê²ƒë¶€í„°)
            data.sort((a, b) => a.timestamp - b.timestamp);
            
            const labels = data.map(item => formatTimestamp(item.timestamp));
            const longData = data.map(item => (parseFloat(item.longAccount) * 100).toFixed(1));
            const shortData = data.map(item => (parseFloat(item.shortAccount) * 100).toFixed(1));
            
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ë¡± í¬ì§€ì…˜ (%)',
                            data: longData,
                            backgroundColor: '#10b981', // ì´ˆë¡ìƒ‰
                            borderColor: '#059669',
                            borderWidth: 1
                        },
                        {
                            label: 'ìˆ í¬ì§€ì…˜ (%)',
                            data: shortData,
                            backgroundColor: '#ef4444', // ë¹¨ê°„ìƒ‰
                            borderColor: '#dc2626',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${symbol} ë¡±/ìˆ í¬ì§€ì…˜ ë¹„ìœ¨`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'ì‹œê°„',
                                padding: {
                                    top: 10
                                }
                            },
                            grid: {
                                display: true,
                                drawBorder: true,
                                drawOnChartArea: true,
                                drawTicks: true
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'ë¹„ìœ¨ (%)',
                                padding: {
                                    bottom: 10
                                }
                            },
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                stepSize: 20
                            },
                            grid: {
                                display: true,
                                drawBorder: true,
                                drawOnChartArea: true,
                                drawTicks: true
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 750,
                        easing: 'easeInOutQuart'
                    },
                    layout: {
                        padding: {
                            left: 10,
                            right: 20,
                            top: 0,
                            bottom: 10
                        }
                    }
                }
            });
        }
        
        // ì‹¤ì‹œê°„ ë°ì´í„°ë¡œ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        async function updateRealTimeChart() {
            const symbol = document.getElementById('symbol-select').value;
            const data = await fetchRealTimeData(symbol);
            
            if (data && data.length > 0) {
                createChart(data, symbol);
            }
        }
        
        // ìƒ˜í”Œ ë°ì´í„°ë¡œ ì°¨íŠ¸ ìƒì„±
        async function showSampleData() {
            const symbol = document.getElementById('symbol-select').value;
            const sampleData = await fetchSampleData(symbol);
            createChart(sampleData, symbol);
            
            // ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¹€
            document.getElementById('error').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
        }
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸° ì°¨íŠ¸ ìƒì„±
        document.addEventListener('DOMContentLoaded', async () => {
            // ì´ˆê¸° ì°¨íŠ¸ ë¡œë“œ (ìƒ˜í”Œ ë°ì´í„°)
            await showSampleData();
            
            // ì‹¬ë³¼ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('symbol-select').addEventListener('change', showSampleData);
            
            // ì‹¤ì‹œê°„ ë°ì´í„° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('refresh-btn').addEventListener('click', updateRealTimeChart);
            
            // ìƒ˜í”Œ ë°ì´í„° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('demo-btn').addEventListener('click', showSampleData);
        });
    </script>
</body>
</html> 